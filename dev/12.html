<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>村通网之也谈 HTTPS | 皮皮凛の小窝</title><meta name="description" content="这是一种能保证你花掉工资&#x2F;零花钱时的愉悦感的技术。"><meta name="keywords" content="HTTPS,SSL,HTTP"><meta name="author" content="绫川星凛"><meta name="copyright" content="绫川星凛"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/favicon.webp"><link rel="canonical" href="https://owomoe.net/dev/12.html"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin="crossorigin"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><meta property="og:type" content="article"><meta property="og:title" content="村通网之也谈 HTTPS"><meta property="og:url" content="https://owomoe.net/dev/12.html"><meta property="og:site_name" content="皮皮凛の小窝"><meta property="og:description" content="这是一种能保证你花掉工资&#x2F;零花钱时的愉悦感的技术。"><meta property="og:image" content="https://owomoe.net/img/pic/7.webp"><meta property="article:published_time" content="2019-03-15T09:00:00.000Z"><meta property="article:modified_time" content="2022-12-27T19:41:03.960Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = '1'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.13.0/css/all.css"><link rel="stylesheet" href="/js/npm/jquery.fancybox.min.css"><link rel="stylesheet" href="/js/npm/snackbar.min.css"><link rel="stylesheet" href="/js/npm/instantsearch.min.css"><script src="/js/npm/instantsearch.min.js" defer></script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-162013750-3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-162013750-3');
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.0.0',
  algolia: {"appId":"1WJL87ATUH","apiKey":"6ada846362dc1e57a8ccfe3fbd3d6c60","indexName":"Blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#F79BBA","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: '/js/npm/jquery.justifiedGallery.min.js',
    css: '/js/npm/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-12-28 03:41:03'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/css/seirin.css"><meta name="generator" content="Hexo 5.0.0"><link rel="alternate" href="/feed/index.xml" title="皮皮凛の小窝" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/logo.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">48</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">81</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/msg"><i class="fa-fw far fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 文章分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 文章标签</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://moegirl.life"><i class="fa-fw fa fa-book"></i><span> 日记本</span></a></div><div class="menus_item"><a class="site-page" href="/other/7.html"><i class="fa-fw fas fa-heart"></i><span> 关于本站</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E5%92%95%E6%9E%9C%E8%B0%88%E8%B5%B7"><span class="toc-number">1.</span> <span class="toc-text">从咕果谈起</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-SSL%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">什么是 SSL？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BF%BB%E5%BC%80%E5%8E%86%E5%8F%B2%E4%B9%A6"><span class="toc-number">3.</span> <span class="toc-text">翻开历史书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%89%E7%AD%89%EF%BC%81"><span class="toc-number">4.</span> <span class="toc-text">等等！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%EF%BC%8C%E5%85%AC%E6%AD%A3%E7%9A%84%E7%AC%AC%E4%B8%89%E6%96%B9"><span class="toc-number">5.</span> <span class="toc-text">欢迎，公正的第三方</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E5%A5%BD%E7%9A%84-HTTPS-%E5%8E%BB%E5%93%AA%E4%BA%86%EF%BC%9F"><span class="toc-number">6.</span> <span class="toc-text">说好的 HTTPS 去哪了？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%B0%B1%E6%98%AF%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82%EF%BC%81"><span class="toc-number">7.</span> <span class="toc-text">接下来就是技术细节！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%98%E6%9C%89%E4%B8%80%E4%BA%9B%E5%B0%8F%E9%97%AE%E9%A2%98%E2%80%A6"><span class="toc-number">8.</span> <span class="toc-text">还有一些小问题…</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/img/pic/7.webp)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">皮皮凛の小窝</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/msg"><i class="fa-fw far fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 文章分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 文章标签</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://moegirl.life"><i class="fa-fw fa fa-book"></i><span> 日记本</span></a></div><div class="menus_item"><a class="site-page" href="/other/7.html"><i class="fa-fw fas fa-heart"></i><span> 关于本站</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">村通网之也谈 HTTPS</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-03-15T09:00:00.000Z" title="发表于 2019-03-15 17:00:00">2019-03-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-27T19:41:03.960Z" title="更新于 2022-12-28 03:41:03">2022-12-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/dev/">dev</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>14分钟</span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><blockquote>
<p>本文转载至<a target="_blank" rel="noopener" href="https://flyhigher.top/develop/1093.html">https://flyhigher.top/develop/1093.html</a></p>
</blockquote>
<blockquote>
<p>这是一种能保证你花掉工资/零花钱时的愉悦感的技术</p>
</blockquote>
<a id="more"></a>
<h2 id="从咕果谈起"><a href="#从咕果谈起" class="headerlink" title="从咕果谈起"></a>从咕果谈起</h2><p>就在不久之前，咕果宣布 Chrome 将在不久之后提前移除对于 <code>HTTPS</code> 网站的“安全”标识，同时对于 <code>HTTP</code> 网站强制显示“不安全”。虽然咕果表示目前 <code>HTTPS</code> 的普及已经达到他们认为足够的地步了，但是我看着国内的进展…啧。</p>
<blockquote>
<p>为什么要使用 <code>HTTPS</code>？<code>HTTPS</code> 提供的不只是加密功能。事实上，许多 Web 新技术，如 <code>HTTP/2</code>，<code>Service Worker</code> 等都需要依托 <code>HTTPS</code> 才能实现，相信这也会成为未来的趋势。</p>
</blockquote>
<h2 id="什么是-SSL？"><a href="#什么是-SSL？" class="headerlink" title="什么是 SSL？"></a>什么是 SSL？</h2><p>从网络模型来看，SSL 在 HTTP 应用层之下，TCP 传输层之上提供了一层传输安全层，确保了经过传输层的数据都是经过加密的。<br><img src="/dev/12/5.jpg" alt></p>
<p>SSL 作为 <code>HTTPS</code> 的基础最早由网景于 1994 年提出。虽然 HTTP 协议本身提供了基本认证和摘要认证（后来提出）两种客户端认证方案，但是毕竟除了用户名和密码外的所有数据仍然是明文传输的（甚至基本认证只对密码信息做了 <code>Base64</code> 编码），要保证传输的安全性还得依靠 SSL。SSL 本身是一种二进制协议，避免了随随便便一个代理就能读取/修改数据的问题。</p>
<p>随着技术发展，SSL 本身也在不断改进。从 SSL 1.0、SSL 2.0 到 SSL 3.0，再到标准化后的 TLS（目前 TLS 1.3 刚刚定稿），这个协议本身也在完善当中。在本文中，我们按照一般惯例使用 SSL 一词同时指代 SSL 和 TLS 两种协议。</p>
<h2 id="翻开历史书"><a href="#翻开历史书" class="headerlink" title="翻开历史书"></a>翻开历史书</h2><p>加密方法离不开数学基础，为了更好地解释加密原理，我们先来了解一下加密的基础知识。当然，如果已经了解了就直接跳过吧。</p>
<p>人类使用加密已经有几千年的历史了。最初，人们使用特定的方法处理文本使其在被截获之后也不会泄露信息。我们通常把这种特定的方法叫做密码。传说凯撒曾使用过一种三位位移密码，也就是将文本中的所有字母替换为这个字母在字母表中后三位的字母。这种方法是一种密码。也就是说，密码 C 接受明文 R 一个参数，输出密文 E。</p>
<p>$$E=C(R)$$</p>
<hr>
<p>然而，使用单一密码的加密非常容易被破译，而且一旦被破译，<strong>以往和未来的所有密文也不再安全。</strong>为了解决这个问题，人们提出了新的方法也就是密钥。用同一种密码加密，输入不同的密钥就会产生不同的结果。比如上文中的三位位移密码，如果把 3 当做密钥，那么不同的密钥（1,2,3,4,5…）就会产生不同的输出。这种时候，就算密码被破译，<strong>只要密钥的可能值足够多</strong>，要得到明文还是相当困难的。也就是，密码 C 现在接受明文 R 和密钥 K 两个参数，产生密文 E。不同的 R 和 K 组合会产生不同的 E。</p>
<p>$$E=C(R,K)$$</p>
<p>然而这种方法仍然有问题。密文的接收方要解密得到明文，必须要得知密码和密钥两个信息。通常密码和密钥组合是变化的（不然就和没有密钥一样了），要正确解密，发送方和接收方每次都必须要交换密码和密钥信息，通常是只交换密钥而密码不变。但密钥存在被截获的可能，要确保安全必须对密钥进行加密，然后加密密钥也需要交换密钥，然后第二个密钥也需要加密…很快这就变成了一个鸡生蛋问题，很明显是不可能实现的。<br><img src="/dev/12/489de23e678fa184bf4b9f471140c827-300x226.jpg" alt></p>
<hr>
<p>到目前为止，我们讨论的都是对称加密，也就是加密和解密用的是相同的密码和密钥。对于无限加密的问题，使用对称加密是无解了。此时，我们的救星非对称加密就登场了。</p>
<p>非对称加密可以使用不同的密钥来分别加密和解密文本，它们通常是配对的，我们叫它们公钥和私钥。使用相同的密码时，接受方只需生成一对公钥和私钥，然后保管好自己的私钥并公开公钥。发送方只需要用商定的密码和接收方的公钥作为密钥来加密文本即可。加密后的文本只有使用私钥才能解开，公钥本身是无法解开的。也就是说，密码 C 对于明文 R 和公钥 PK 产生的输出只能由与密码 C 对应的解码 D 和公钥 PK 对应的私钥 SK 才能解密回明文。</p>
<p>$$D(C(R,PK),SK)=R$$</p>
<blockquote>
<p>这里就不详述数学上的证明了，有兴趣的可以自行了解。</p>
</blockquote>
<p>通过这种方式，接收方可以保证密文只能由接受方进行解码，交换公钥并不会破坏加密的安全性。更棒的是，<strong>私钥和公钥是可以互换的</strong>，即是，使用公钥 PK 加密并使用私钥 SK 解密得到的结果和使用私钥 SK 加密并使用公钥 PK 解密得到的结果是一致的，<strong>都是原始明文</strong>。</p>
<p>$$D(C(R,PK),SK)=D(C(R,SK),PK)=R$$</p>
<p>这样的话，我们甚至可以使用非对称加密验证接收方的身份。毕竟只有接收方拥有私钥，可以要求接收方用私钥加密明文并试图用其公钥解密来确保对方就是拥有正确私钥的那一方。如此看来，有了非对称加密，似乎一切都完美了。</p>
<h2 id="等等！"><a href="#等等！" class="headerlink" title="等等！"></a>等等！</h2><p>你可能会发现一些问题。如果有一个聪明的中间人（或者说网络中的某一台代理），<strong>他可能可以轻松破解非对称加密</strong>。</p>
<p>对的！试想以下的场景： A 和 B <del>作为两位优秀的魔法少女</del>常常需要互通信件，然而不巧邪恶的 E 同学总是试图偷看 A 和 B 的对话，于是 A 和 B 决定使用非对称加密来加密信件以解决问题。</p>
<p>然而 E 同学想出了一个办法。A 向 B 发送信件时，B 会先向 A 发送她的公钥以便 A 加密文本，这时 E 将其截获，记下 B 的公钥然后自己生成一套公钥和私钥并将自己的公钥伪装成 B 的信件重新发送给 A。<strong>不知情</strong>的 A 会用 E 的公钥加密文本并发回给 B。E 可以再次截获信件，此时他利用自己的私钥便可以轻松读取信中的内容了。然后 E 将信件重新使用 B 的公钥加密并发送给 B，这样 B <strong>也不会发现异常</strong>，认为自己成功与 A 完成了一次沟通，殊不知 E 已经读取到了信的内容。当 B 要向 A 寄信时，E 可以如法炮制读取 A 和 B 的对话。</p>
<p>怎么办才能避免 E 读取内容呢？幸好，我们有一种方法可以在 E 偷偷摸摸更换密钥时就发现问题并及时停止。要使用这种方法，我们需要有请我们的下一位选手登场。</p>
<h2 id="欢迎，公正的第三方"><a href="#欢迎，公正的第三方" class="headerlink" title="欢迎，公正的第三方"></a>欢迎，公正的第三方</h2><p>现在，作为第三方的 C 登场了。他会作为一个验证人帮助信件的接收方验证收到的信件有没有经过篡改以及是不是真的由 B 发出的。</p>
<p>整个过程这样进行。C 先生成一对公私钥，然后将公钥<strong>亲自告诉 A 和 B</strong>。A 发信给 B 时，C 会提前把 B 的公钥和一些 B 和 C 的基本信息放在一起，然后用自己的私钥加密这段信息并将密文交给 B。B 随后只需将这段密文交给 A 即可。A 随后会试着使用 C 的公钥解开密文，如果成功了，那就说明信件没有经过篡改，并且 A 也安全地获得了 B 的公钥。如果失败了，就说明有人篡改了这段密文，信件即作废。当 B 给 A 寄信时将整个过程反过来即可。看，这样我们就可以安全的交换密钥而不用担心内容被窃听了。可怜的 E 现在束手无策。</p>
<h2 id="说好的-HTTPS-去哪了？"><a href="#说好的-HTTPS-去哪了？" class="headerlink" title="说好的 HTTPS 去哪了？"></a>说好的 HTTPS 去哪了？</h2><p>别激动，其实 A、B、C、E 的故事就是一次典型的 <code>HTTPS</code> 连接。</p>
<p>慢慢来，实际情况会比上面的故事稍稍复杂一些。我们把 A 看作客户端，通常情况下也就是浏览器，B 看作服务器，E 看作网络链路上某台邪恶的代理，C 是一位公正的第三方，顺便，我们把 C 交给 B 的那段含有一些基本信息和 B 的公钥的密文叫做数字证书。现在，我们可以把 C 叫做证书颁发机构。</p>
<p>在真实情况下，数字证书会包含一些加密的基本信息。毕竟数字证书并没有统一的标准，这些加密信息会用来告诉 A 如何解密数字证书。当然这些信息不会被加密，不然 A 完全无法解密数字证书。因此现实情况下，C 会对数字证书包含的所有内容建立一个摘要（你可以把它当做简介），然后只对这个摘要用自己的私钥进行加密。这个过程叫做签名。当 A 收到证书后，会解密这段摘要，然后自己通过相同的算法独立算出证书的摘要——如果是一样的，那就没问题了。</p>
<p><img src="/dev/12/snipaste.jpg" alt></p>
<hr>
<p>那么现在开始连接。A 向 B 发出了一个请求。在建立连接后，B 会将数字证书发送给 A。A 会验证数字证书（甚至会询问 C 确保这张证书没有作废）。如果成功，A 会利用从证书中取得的 B 的公钥在加密环境下协商出一个一致的临时密钥，接下来双方会用这个密钥<strong>进行对称加密</strong>来互相交流。</p>
<blockquote>
<p>等等！在这种情况下，B 没有 A 的公钥，他是怎么回答 A 来完成临时密钥的协商的呢？啊哈！实际上 B 并不需要回复 A 来完成协商。在整个过程中，只需要 A 向 B 发送一条加密信息，双方即可计算出相同的临时密钥。至于技术细节，我们稍后就谈。</p>
</blockquote>
<blockquote>
<p>那为什么需要临时密钥呢？那是因为非对称加密需要的计算量远大于对称加密。只需要保证密钥不泄露，对称加密是安全的。利用非对称加密来交换对称加密密钥完美解决了密钥交换问题，两种加密方法的混合使用也保证了安全和性能的平衡。</p>
</blockquote>
<p>这就完成了！现在 A 和 B 可以使用相同的密钥进行对称加密通信在这个基础上，A 和 B 可以使用标准的 HTTP 协议进行交流。同时由于没能截获密钥，可怜的 E 同学再次扑了个空。我们成功完成了一次加密的 HTTPS 通信。</p>
<h2 id="接下来就是技术细节！"><a href="#接下来就是技术细节！" class="headerlink" title="接下来就是技术细节！"></a>接下来就是技术细节！</h2><p>在加密建立的过程中，算法不同会导致实际实现的不同——尽管并没有太大差别。</p>
<p>简单来看，我们可以将其分为 <code>RSA</code> 算法和 <code>DH</code> 算法。两种算法建立加密的过程我们都会介绍。</p>
<hr>
<p>开始时两种加密算法的实现是一致的。浏览器准备发出一个请求到一台服务器。首先浏览器打开了到该服务器 <code>443</code> 端口的 TCP 连接，准备开始 SSL 握手。</p>
<p>随后，浏览器生成一串随机数并附上自己支持的协议版本和加密方法等一并发送给服务器。协议版本即指 SSL/TLS 协议版本，而加密方式是指实现加密使用的具体算法，也就是密码。这个过程被称为 <code>ClientHello</code>。</p>
<p>接着，服务器会发回确定下来的协议版本和加密方式，以及一串由服务器生成的随机数及数字证书。此时，如果双方没有共同支持的协议版本或加密方式，连接就会断开，浏览器显示错误信息。这个过程被称为 <code>SeverHello</code>。</p>
<p>浏览器会检查服务器证书。数字证书目前没有一个统一的标准，不过使用最广泛的标准是 <code>X.509</code>，版本 3。浏览器会解析证书，检查其签发者是否是可信的，并会试图使用该签发者的公钥来检查证书是否经过篡改。浏览器还会检查证书是否到期、证书包含的主机名和当前主机名是否匹配，甚至会向证书颁发机构的在线服务询问证书是否被注销。一旦有任何一条检查出现问题，浏览器就会中断连接并显示错误信息。</p>
<blockquote>
<p>浏览器是如何检查证书颁发机构是否可信的？基本上，在每一台联网设备里，都有一套可信机构列表。这些机构和它们的公钥被直接存储于每一台计算机中，因此不用担心被篡改（还记得上面的故事里 C 是亲自告诉 A 和 B 他的公钥的么？）。当然，用户可以添加自己的证书来让浏览器信任自己签发的证书，但这仅限于单台计算机。通常，这些在列表中的机构还会为其他机构签发证书。此时，这些其他机构签发的证书也会被系统所信任，这便构成了证书链。</p>
</blockquote>
<p>通常情况下，浏览器还会检查一些其他信息，如证书透明度信息等，就不再概述了。</p>
<hr>
<p><strong>不同算法的不同实现在这里开始出现分歧。</strong>我们先来介绍 <code>RSA</code> 算法的实现。</p>
<p>在这时，浏览器产生整个过程中的最后一个随机数，并将它使用服务器的公钥加密，发送给服务器，即 <code>Client Key Exchange</code>。</p>
<p>这时，双方会通过已有的 3 个随机数各自计算出临时密钥。如果没有差错，双方的计算结果应该是相同的。随后，双方会互发 <code>Change Cipher Spec</code> 消息确认接下来的数据传输已经可以切换到加密方式。</p>
<blockquote>
<p>为什么需要随机数？因为数字证书本身是静态的，要保障安全性，我们需要每次连接时都有不同的密钥，这个密钥便是由双方提出的随机数计算而得的，这种方式增强了连接的安全性。</p>
</blockquote>
<hr>
<p>对于 <code>DH</code> 算法，此时服务器会利用私钥将浏览器生成的随机数、服务器随机数和服务器 DH 参数签名，生成服务器签名，并随后发送服务器 DH 参数和服务器签名，这是 <code>Server Key Exchange</code>。</p>
<p>紧接着浏览器也会发送客户端 DH 参数（<code>Client Key Exchange</code>），随后双方即可独立计算出临时密钥，切换至加密协议（<code>Change Cipher Spec</code>）。</p>
<hr>
<p><strong>最后，两种加密算法的实现又变得一致。</strong>双方会互换这一轮握手过程中发送/接受到的信息的散列值以确保在握手过程中没有数据被恶意替换，这是 <code>Finished</code>。</p>
<p>通过抓包可以看出两种实现的不同。（图源网络）<br><code>RSA</code>:<br><img src="/dev/12/ssl_handshake_rsa_shake1.jpg" alt></p>
<p><code>DH</code>:<br><img src="/dev/12/ssl_handshake_dh_shake1.jpg" alt></p>
<p>到这里，浏览器和服务器已经成功建立了安全的 SSL 连接。接下来，标准的 HTTP 协议就可以由 SSL 传输安全层负载进行传输了。从 TCP 传输层来看，这些数据是原始的二进制数据，即使有人截获也无法将其解密。</p>
<h2 id="还有一些小问题…"><a href="#还有一些小问题…" class="headerlink" title="还有一些小问题…"></a>还有一些小问题…</h2><p>通常情况下，你要访问一个网站，浏览器会在发给服务器的请求中附带一个 <code>host</code> 字段来告诉服务器要访问哪个网站。这对于一个服务器上托管了多个网站的情况（很常见）很有用，服务器可以立刻明白你要访问哪个网站并把对应的数据发回浏览器。</p>
<p>但是，在访问使用 <code>HTTPS</code> 的网站时，SSL 握手的过程中浏览器并不会告诉服务器要访问哪个网站（这是在 HTTP 协议下发出的，而 HTTP 通信会在 SSL 连接建立之后才开始）。这会导致服务器不知道你需要哪张证书<strong>且往往会将错误的证书发送给你</strong>。这通常会导致证书验证失败。</p>
<p>为了解决这一问题，人们提出了 <code>SNI</code>，一个 TLS 拓展协议。<code>SNI</code> 会在 SSL 握手时就向服务器发送要访问的主机名，以便服务器发回正确的证书。<strong>目前绝大部分服务器软件和客户端都支持这一拓展协议。</strong></p>
<hr>
<p>在 SSL 加密开始后，在 TCP 传输层上传输的就是完完全全的二进制数据。对于代理来说，这不是什么好事。对于这样的数据，它们完全不知道应该向哪里转发。</p>
<blockquote>
<p>当然，盲转发代理是不可取的。盲转发是指对数据包不做处理直接转发的行为。这会彻底地破坏 <code>HTTP/1.1</code> 中引入的长连接，在拖慢速度的同时还大大加重的服务器的负担。因此通常情况下代理会解析 HTTP 头以获得一些连接的基本信息。</p>
</blockquote>
<p>一种解决方案是使用 HTTPS SSL 隧道协议，这通常是使用 HTTP <code>CONNECT</code> 方法实现的，具体细节就不再详述了。除此之外也有很多方法，有兴趣可以自行了解。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">绫川星凛</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://owomoe.net/dev/12.html">https://owomoe.net/dev/12.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明来自 <a href="https://owomoe.net" target="_blank">皮皮凛の小窝</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/HTTPS/">HTTPS</a><a class="post-meta__tags" href="/tags/SSL/">SSL</a><a class="post-meta__tags" href="/tags/HTTP/">HTTP</a></div><div class="post_share"><div class="social-share" data-image="/img/pic/7.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.bootcss.com/social-share.js/1.0.16/css/share.min.css"><script src="https://cdn.bootcss.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://afdian.net/@seirin" target="_blank"><img class="post-qr-code-img" src="/img/afdian.webp" alt="爱发电：微信支付宝扫码"/></a><div class="post-qr-code-desc">爱发电：微信支付宝扫码</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/dev/16.html"><img class="prev-cover" src="/img/pic/7.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">教程向：使用阿里云对象存储(OSS)搭建静态网站~</div></div></a></div><div class="next-post pull-right"><a href="/dev/11.html"><img class="next-cover" src="/img/pic/7.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">电信直连CN2线路与163传统线路</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/dev/16.html" title="教程向：使用阿里云对象存储(OSS)搭建静态网站~"><img class="relatedPosts_cover" src="/img/pic/7.webp"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2019-06-29</div><div class="relatedPosts_title">教程向：使用阿里云对象存储(OSS)搭建静态网站~</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(/img/pic/7.webp)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2022 By 绫川星凛</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">你好，再见</div><div class="icp"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn"><span>鲁ICP备20020678号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="/js/npm/jquery.min.js"></script><script src="/js/utils.min.js"></script><script src="/js/main.min.js"></script><script src="/js/tw_cn.min.js"></script><script src="/js/npm/jquery.fancybox.min.js"></script><script src="/js/npm/instantpage.min.js" type="module" defer></script><script src="/js/npm/snackbar.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: 'RimuW5sTDoBQq76cpqtFxS6a-gzGzoHsz',
      appKey: 'VrDSkBwEiw7br1m6PPEEbwIs',
      placeholder: '快来和大家一起讨论吧~',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-cn',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('/js/npm/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="/live2dw/lib/L2Dwidget.min.js"></script><script src="/js/seirin.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/third-party/click_heart.min.js" async="async"></script></div></body></html>